<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <style>
        #contactTable tr td {
            padding: 5px;
            margin-left: 0px;
        }
        #main {
            background-color: lightblue;
        }
        #remove {
            background-color: white;
            color: red;
        }
        .contact {
            background-color: pink;
        }
        .personal {
            background-color: lightgray;
        }
    </style>
</head>
<body>
    <h1>Contact Manager</h1>
       <form method="GET" action="">
            <table>
                <tr>
                    <td>
                        <input type="text" id="fName" placeholder="Име" name="firstName">
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="text" id="lName" placeholder="Фамилия" name="lastName">
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="email" placeholder="name@no.com" id="email" name="email">
                    </td>
                </tr>
                <tr>
                    <td>
                        <fieldset>
                            <legend>Тип</legend>
                            <label><input type="radio" name="contactType" value="1" checked="checked" id="business">Бизнес</label>
                            <br>
                            <label><input type="radio" name="contactType" value="2" id="personal">Личен</label>
                        </fieldset>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="button" value="Add" id="add">
                        <input type="button" value="Update" id="update" style="display: none;">
                        <input type="button" value="Cancel" id="cancel" style="display: none;">
                    </td>
                </tr>
            </table>
        </label>
    </form>
    <table id="contactTable">
        <tr id="main">
            <td>&numero;</td>
            <td>Име</td>
            <td>Фамилия</td>
            <td>E-mail</td>
            <td>Тип клиент</td>
            <td>&nbsp</td>
            <td>&nbsp</td>
        </tr>
    </table>
    <template id="contactData">
        <tr class="contact">
            <td class="contactNumber"></td>
            <td class="firstName"></td>
            <td class="lastName"></td>
            <td class="email">
                <a href="#"></a>
            </td>
            <td class="contactType">
                <label>
                    <input type="checkbox"
                           class="changeType"
                           data-on="Бизнес"
                           data-off="Личен"
                           value="1"
                           checked="checked"/>
                    <span></span>
                </label>
            </td>
            <td><input type="button" value="&times" id="remove">
            <td><input type="button" value="Edit" id="edit">
        </tr>
    </template>
    <noscript>
        Моля, разрешете изпълнението на JS за да използвате 
        услугите на сайта!
    </noscript>
    <script src="./js/jquery-3.3.1.min.js"></script>
    <script src="./js/contacts.js"></script>
    <script>
        $(document).ready(function(){
            var counter = 0,
                t = $('#contactData').html();

            counter = loadContacts(contacts, $('#contactTable'), $(t));

            $('#add').click(function(){
                var tr$ = $(t),
                    contact = getFormContact('form');
                
                if (findContactIndex(contacts, contact) !== - 1) return;
                    
                //тези редове няма да се изпълнят ако контактът съществува
                tr$.find('.contactNumber').html(++counter);
                addRow('#contactTable', tr$, contact);
                contacts.push(contact);
                $('#update').hide();
                $(this).show("Add");
                $('.edit').removeClass('edit');
                console.log(contacts);
            });//on add button click
            
            
            
            $('#contactTable').on('click','.changeType', function(){
                var tr$ = $(this).parents('tr');
                    type = ( $(this).is(':checked') )? "1" : "2";
                    updateCheckbox(tr$, type);
                    //console.log(contacts);
            });
            
            $('#contactTable').on('click','#remove',function(){
                $(this).parents('tr').fadeOut('300', function(){
                    var email = $(this).find('.email a').html();
                    var contactType = $(this).find('.changeType').val();
                    var index = findContactIndex(contacts, 
                                                 {
                                                   "contactType": contactType,
                                                   "email": email
                                                 });
                    console.log('index: ' + index + 'email: ' + email);

                    if(index !== -1) {
                        contacts.splice(index, 1);
                    }
                    $(this).remove();
                    
                    var number=0;
                    $('td.contactNumber').each(function(index, elm){
                        elm.innerHTML = index + 1;
                        number++;
                    });
                    
                    counter = number;
                    
                    
                });
                console.log(contacts);
            });//on remove button click
            
            $('#contactTable').on('click', '#edit', function(){
                var tr$ = $(this).parents('tr');
                var contact = {
		                        email: tr$.find('.email a').text(),
		                        contactType: tr$.find('.changeType').val()
		                      };
                var index = findContactIndex(contacts, contact);
                
                console.log('index: ' + index + ' contact: ', contact);
                if (index === -1) return;
	            
                contacts[index]
                $('#fName').val(contacts[index].firstName);
	            $('#lName').val(contacts[index].lastName);
	            $('#email').val(contacts[index].email);
                
                $('input:radio[name="contactType"]').removeAttr('checked');
                
                $('input:radio[value="' + contacts[index].contactType + '"]').attr('checked', true);
                console.log(contacts[index].contactType);
                tr$.addClass('edit');
                $('#add').val("Add as New Contact");
                $('#update').show();
                $('#cancel').show();
            });//on edit button click
            
            $('#update').click(function(){    
                var tr$ = $(t),
                    contact = getFormContact('form'),
                    index = findContactIndex(contacts, contact),
                    rowEmail = $('.edit').find('.email a').html(),
                    formEmail = $('#email').val();
                
                tr$.find('.contactNumber').html(index + 1);
                
                if (formEmail === rowEmail) {
                    updateRow('#contactTable', tr$, contact);
                    contacts[index] = contact;
                } 
                else {
                    alert('A contact with this e-mail already exists. Please add as new contact');
                }
                
                        
                console.log(contacts);
                
                $('.edit').removeClass('edit');  
                clearForm();
            });//on button update click
            
            $('#cancel').click(function(){
                clearForm();
                $('.edit').removeClass('edit'); 
            });//on button cancel click
            
        });//on document ready
        
        function loadContacts (data, contactTable, template) {
            var counter = 0;
            
            $.each(data, function(index, contact) {
                var newRow$ = template.clone();

                newRow$.find('.contactNumber').html(++counter);
                newRow$.find('.firstName').html(contact.firstName);
                newRow$.find('.lastName').html(contact.lastName);
                newRow$.find('.email a').html(contact.email)
                                        .attr('href', 'mailto:' + contact.email);
                
                updateCheckbox(newRow$, contact.contactType);
                contactTable.append(newRow$);
            });//for each contact in table
            
            return counter;
        };
        
        function updateCheckbox(row$, contactType){
            var state = 'on',
                className = 'personal',
                checkbox$ = row$.find('.changeType');
           
            if ( contactType === '2' ) {
	           state = 'off';
	           checkbox$.removeAttr('checked');
            
            }
            checkbox$.val(contactType);
            checkbox$.next().html(checkbox$.data(state));
            row$.toggleClass(className, !checkbox$.is(':checked')); 
        }
        
        function findContactIndex(contacts, contact) {
            return contacts.indexOf(contacts.find(c =>c.email === contact.email));
        }
        
        function addRow(tableId, row$, contact) {
            $.each(contact, function(field, value) {
                if(field === 'contactType') {
                    updateCheckbox(row$, value);
                }
                else if (field === 'email') {
                    row$.find('.email a').html(value)
                                         .attr('href', 'mailto:' + value);
                }
                else{
                    row$.find('.' + field).html(value);
                }
            });
            $(tableId).append(row$);
        }
        
        function updateRow(tableId, row$, contact) {
            var counter = 0;
            $.each(contact, function(field, value) {
                if(field === 'contactType') {
                    updateCheckbox(row$, value);
                }
                else if (field === 'email') {
                    row$.find('.email a').html(value)
                                         .attr('href', 'mailto:' + value);
                }
                else{
                    row$.find('.' + field).html(value);
                }
                
            });
            $('.edit').replaceWith(row$);
            
        }
        
        function getFormContact(formId) {
            var contact = {};
            var data = $(formId).serializeArray();

            data.forEach(function(field) {
                contact[field.name] = field.value;
            });//for each field in contact form

            return contact;
        }
        
        function clearForm(){
            $('#fName').val('');
            $('#lName').val('');
            $('#email').val('');
            $('#update').hide();
            $('#cancel').hide();
            $('#add').val("Add");
        }
    </script>
</body>
</html>